# Taurscribe Threading & Audio Pipeline - Visual Guide

> **A step-by-step visual breakdown of how threads are created, how audio flows through the system, and how it gets to the Whisper model**

---

## ğŸ“‹ Table of Contents

1. [Thread Creation Timeline](#thread-creation-timeline)
2. [Complete Threading Architecture](#complete-threading-architecture)
3. [Audio Data Flow](#audio-data-flow)
4. [Resampling Pipeline (48kHz â†’ 16kHz)](#resampling-pipeline-48khz--16khz)
5. [Whisper Processing Pipeline](#whisper-processing-pipeline)
6. [Thread Lifecycle](#thread-lifecycle)

---

## Thread Creation Timeline

### **When You Click "Start Recording"**

```
USER CLICKS BUTTON
      â”‚
      â”‚ [Frontend - App.tsx]
      â”‚ onClick={() => invoke("start_recording")}
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           MAIN THREAD (Tauri Event Loop)                        â”‚
â”‚                                                                 â”‚
â”‚  [1] ğŸ¯ start_recording() called                                â”‚
â”‚      â”œâ”€ Get microphone (cpal)                                  â”‚
â”‚      â”œâ”€ Create WAV file spec                                   â”‚
â”‚      â””â”€ Create channels (unbounded)                            â”‚
â”‚                                                                 â”‚
â”‚  [2] ğŸ“¦ Create Channels                                         â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚      â”‚  let (file_tx, file_rx) = unbounded(); â”‚                â”‚
â”‚      â”‚  let (whisper_tx, whisper_rx) = unbounded(); â”‚          â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                 â”‚
â”‚  [3] ğŸš€ SPAWN THREAD 1                                          â”‚
â”‚      std::thread::spawn(move || { ... })                       â”‚
â”‚      â”‚                                                          â”‚
â”‚      â””â”€â”€â–º Creates: FILE WRITER THREAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                                                           â”‚     â”‚
â”‚  [4] ğŸš€ SPAWN THREAD 2                                    â”‚     â”‚
â”‚      std::thread::spawn(move || { ... })                 â”‚     â”‚
â”‚      â”‚                                                    â”‚     â”‚
â”‚      â””â”€â”€â–º Creates: WHISPER PROCESSOR THREAD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚     â”‚
â”‚                                                       â”‚   â”‚     â”‚
â”‚  [5] ğŸ™ï¸ CREATE AUDIO STREAM                           â”‚   â”‚     â”‚
â”‚      device.build_input_stream(                       â”‚   â”‚     â”‚
â”‚          |audio_data| { ... }  // Callback           â”‚   â”‚     â”‚
â”‚      )                                                â”‚   â”‚     â”‚
â”‚      â”‚                                                â”‚   â”‚     â”‚
â”‚      â””â”€â”€â–º Creates: AUDIO CALLBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚     â”‚
â”‚                                                   â”‚   â”‚   â”‚     â”‚
â”‚  [6] â–¶ï¸ stream.play()                             â”‚   â”‚   â”‚     â”‚
â”‚      All systems GO!                              â”‚   â”‚   â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”˜
                                                    â”‚   â”‚   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
                    â”‚                                   â”‚   â”‚
                    â–¼                                   â”‚   â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚   â”‚
        â”‚  AUDIO STREAM CALLBACK  â”‚                    â”‚   â”‚
        â”‚  (Runs in OS thread,    â”‚                    â”‚   â”‚
        â”‚   every ~10ms)          â”‚                    â”‚   â”‚
        â”‚                         â”‚                    â”‚   â”‚
        â”‚  |audio_data| {         â”‚                    â”‚   â”‚
        â”‚    file_tx.send(...)    â”œâ”€â”€â”€â”€â”               â”‚   â”‚
        â”‚    whisper_tx.send(...) â”œâ”€â”€â” â”‚               â”‚   â”‚
        â”‚  }                      â”‚  â”‚ â”‚               â”‚   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚               â”‚   â”‚
                                     â”‚ â”‚               â”‚   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚               â”‚   â”‚
                    â”‚                  â”‚               â”‚   â”‚
                    â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”˜
                    â”‚                                  â”‚
                    â–¼                                  â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  THREAD 2:            â”‚        â”‚  THREAD 1:             â”‚
        â”‚  WHISPER PROCESSOR    â”‚        â”‚  FILE WRITER           â”‚
        â”‚                       â”‚        â”‚                        â”‚
        â”‚  while recv() {       â”‚        â”‚  while recv() {        â”‚
        â”‚    buffer += samples  â”‚        â”‚    write_sample()      â”‚
        â”‚    if buffer >= 6s {  â”‚        â”‚  }                     â”‚
        â”‚      transcribe()     â”‚        â”‚  finalize_wav()        â”‚
        â”‚    }                  â”‚        â”‚                        â”‚
        â”‚  }                    â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOTAL THREADS CREATED:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â‘  Main Thread (Tauri event loop) - Already running
â‘¡ File Writer Thread - Created by std::thread::spawn
â‘¢ Whisper Processor Thread - Created by std::thread::spawn
â‘£ Audio Stream Thread - Created by cpal (OS-level)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
= 4 CONCURRENT THREADS
```

---

## Complete Threading Architecture

### **Visual Thread Map**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ğŸ–¥ï¸ MAIN THREAD                                â”‚
â”‚                        (Tauri Event Loop)                             â”‚
â”‚                                                                       â”‚
â”‚  â€¢ Handles UI events                                                 â”‚
â”‚  â€¢ Manages application state (AudioState)                            â”‚
â”‚  â€¢ Responds to invoke() calls from frontend                          â”‚
â”‚  â€¢ Spawns worker threads                                             â”‚
â”‚                                                                       â”‚
â”‚  [AudioState - Shared via Arc<Mutex>]                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚ â€¢ recording_handle: Mutex<Option<...>> â”‚                          â”‚
â”‚  â”‚ â€¢ whisper: Arc<Mutex<WhisperManager>>  â”‚ â—„â”€â”€â”                     â”‚
â”‚  â”‚ â€¢ last_recording_path: Mutex<...>      â”‚    â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                               â”‚                    â”‚
                â–¼                               â”‚                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ™ï¸ OS AUDIO THREAD       â”‚                  â”‚    â”‚  ğŸ“ THREAD 1             â”‚
â”‚  (Created by cpal)        â”‚                  â”‚    â”‚  File Writer             â”‚
â”‚                           â”‚                  â”‚    â”‚                          â”‚
â”‚  Every ~10ms:             â”‚                  â”‚    â”‚  Loop: {                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚    â”‚    samples = file_rx     â”‚
â”‚  â”‚ Microphone â†’        â”‚  â”‚                  â”‚    â”‚         .recv()          â”‚
â”‚  â”‚ 48kHz Stereo        â”‚  â”‚                  â”‚    â”‚    for s in samples {    â”‚
â”‚  â”‚ [L,R,L,R,L,R...]    â”‚  â”‚                  â”‚    â”‚      writer.write(s)     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚    â”‚    }                     â”‚
â”‚         â”‚                 â”‚                  â”‚    â”‚  }                       â”‚
â”‚         â–¼                 â”‚                  â”‚    â”‚  writer.finalize()       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚    â”‚                          â”‚
â”‚  â”‚ Split into 2 copies â”‚  â”‚                  â”‚    â”‚  ğŸ“ Output:              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                  â”‚    â”‚  recording_XXX.wav       â”‚
â”‚         â”‚      â”‚           â”‚                  â”‚    â””â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚      â”‚           â”‚                  â”‚           â”‚
â”‚         â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚                  â”‚                  â”‚    Channel: file_tx/rx
â”‚         â”‚                  â”‚                  â”‚
â”‚         â”‚ Mix stereoâ†’mono  â”‚                  â”‚
â”‚         â”‚ [L,R] â†’ [(L+R)/2]â”‚                  â”‚
â”‚         â”‚                  â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            â”‚                  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚           â”‚
                                                â”‚           â”‚
                                                â”‚           â–¼
                                                â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                â”‚    â”‚  ğŸ§  THREAD 2             â”‚
                                                â”‚    â”‚  Whisper Processor       â”‚
                                                â”‚    â”‚                          â”‚
                                                â”‚    â”‚  let mut buffer = Vec    â”‚
                                                â”‚    â”‚  chunk_size = SR * 6     â”‚
                                                â”‚    â”‚                          â”‚
                                                â”‚    â”‚  Loop: {                 â”‚
                                                â”‚    â”‚    mono = whisper_rx     â”‚
                                                â”‚    â”‚            .recv()       â”‚
                                                â”‚    â”‚    buffer.extend(mono)   â”‚
                                                â”‚    â”‚                          â”‚
                                                â”‚    â”‚    if buffer >= 6s {     â”‚
                                                â”‚    â”‚      chunk = buffer[0..6s]â”‚
                                                â”‚    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                                â”‚    â”‚      â”‚ RESAMPLE       â”‚  â”‚
                                                â”‚    â”‚      â”‚ 48kHz â†’ 16kHz  â”‚  â”‚
                                                â”‚    â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                â”‚    â”‚              â–¼           â”‚
                                                â”‚    â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                                â””â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¤ WHISPER MODEL  â”‚  â”‚
                                                     â”‚      â”‚ (GPU/CPU)      â”‚  â”‚
                                                     â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                                     â”‚               â”‚          â”‚
                                                     â”‚               â–¼          â”‚
                                                     â”‚      println!("text")    â”‚
                                                     â”‚    }                     â”‚
                                                     â”‚  }                       â”‚
                                                     â”‚                          â”‚
                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                          Channel: whisper_tx/rx

THREAD COMMUNICATION:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Audio Thread â”€â”€file_txâ”€â”€â”€â–º File Writer Thread
Audio Thread â”€â”€whisper_txâ”€â–º Whisper Thread â”€â”€Arc<Mutex>â”€â”€â–º WhisperManager
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

---

## Audio Data Flow

### **Complete Journey: Microphone â†’ Transcript**

```
STEP 1: AUDIO CAPTURE (OS Audio Thread)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ¤ MICROPHONE
    â”‚
    â”‚ Every 10ms (default buffer size)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Raw Audio Samples (f32)                                        â”‚
â”‚  [0.001, -0.003, 0.002, -0.001, 0.004, -0.002, ...]            â”‚
â”‚                                                                 â”‚
â”‚  Format:                                                        â”‚
â”‚  â€¢ Sample Rate: 48000 Hz (48,000 samples per second)           â”‚
â”‚  â€¢ Channels: 2 (Stereo: Left + Right)                          â”‚
â”‚  â€¢ Format: f32 (floating point -1.0 to +1.0)                   â”‚
â”‚  â€¢ Buffer Size: ~480 samples (10ms @ 48kHz)                    â”‚
â”‚  â€¢ Data Layout: [Lâ‚, Râ‚, Lâ‚‚, Râ‚‚, Lâ‚ƒ, Râ‚ƒ, ...]                 â”‚
â”‚                                                                 â”‚
â”‚  Example (4 samples):                                           â”‚
â”‚  [0.1, 0.15, -0.2, -0.18, 0.3, 0.28, -0.1, -0.12]             â”‚
â”‚    Lâ‚   Râ‚    Lâ‚‚    Râ‚‚    Lâ‚ƒ   Râ‚ƒ    Lâ‚„    Râ‚„                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â”‚ Callback function in device.build_input_stream()
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AUDIO CALLBACK (Runs in OS thread)                            â”‚
â”‚                                                                 â”‚
â”‚  move |data: &[f32], _: &_| {                                  â”‚
â”‚      // `data` points to the raw audio buffer                  â”‚
â”‚      //                                                         â”‚
â”‚      // FORK INTO TWO PATHS:                                   â”‚
â”‚      //                                                         â”‚
â”‚      // PATH 1: Stereo for File                                â”‚
â”‚      file_tx.send(data.to_vec()).ok();                         â”‚
â”‚      //                                                         â”‚
â”‚      // PATH 2: Mono for Whisper                               â”‚
â”‚      let mono = mix_to_mono(data, channels);                   â”‚
â”‚      whisper_tx.send(mono).ok();                               â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                              â”‚
        â”‚ (Stereo)                     â”‚ (Mono)
        â”‚                              â”‚
        â–¼                              â–¼

STEP 2A: FILE PATH                STEP 2B: WHISPER PATH
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”             â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Channel: file_tx/rx â”‚            â”‚ Channel:             â”‚
â”‚                     â”‚            â”‚ whisper_tx/rx        â”‚
â”‚ [L,R,L,R,L,R,L,R]  â”‚            â”‚                      â”‚
â”‚ (Stereo preserved)  â”‚            â”‚ Stereo â†’ Mono        â”‚
â”‚                     â”‚            â”‚ Conversion:          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚                      â”‚
          â”‚                        â”‚ [Lâ‚,Râ‚] â†’ (Lâ‚+Râ‚)/2 â”‚
          â–¼                        â”‚ [Lâ‚‚,Râ‚‚] â†’ (Lâ‚‚+Râ‚‚)/2 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚                      â”‚
â”‚ Thread 1:           â”‚            â”‚ Result:              â”‚
â”‚ File Writer         â”‚            â”‚ [Mâ‚, Mâ‚‚, Mâ‚ƒ, ...]   â”‚
â”‚                     â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ while recv() {      â”‚                       â”‚
â”‚   write_sample()    â”‚                       â–¼
â”‚ }                   â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     â”‚            â”‚ Thread 2:            â”‚
â”‚ Output Format:      â”‚            â”‚ Whisper Processor    â”‚
â”‚ WAV, 48kHz, Stereo  â”‚            â”‚                      â”‚
â”‚                     â”‚            â”‚ Buffer: Vec<f32>     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚ Size: 0 â†’ 288000     â”‚
                                   â”‚       (6s @ 48kHz)   â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Mono Conversion Detail**

```
INPUT: Stereo samples [L, R, L, R, L, R]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Example stereo data:
[0.1, 0.15, -0.2, -0.18, 0.3, 0.28]
  Lâ‚   Râ‚     Lâ‚‚    Râ‚‚     Lâ‚ƒ   Râ‚ƒ

CONVERSION ALGORITHM:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

let mono_data: Vec<f32> = if channels > 1 {
    data.chunks(2)              // Split into pairs: [(Lâ‚,Râ‚), (Lâ‚‚,Râ‚‚), ...]
        .map(|chunk| {
            chunk.iter().sum::<f32>() / 2.0  // Average each pair
        })
        .collect()
} else {
    data.to_vec()  // Already mono
};

STEP-BY-STEP:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

chunks(2):
  [0.1, 0.15]  â†’  (0.1 + 0.15) / 2 = 0.125    = Mâ‚
  [-0.2, -0.18] â†’ (-0.2 + -0.18) / 2 = -0.19  = Mâ‚‚
  [0.3, 0.28]   â†’ (0.3 + 0.28) / 2 = 0.29     = Mâ‚ƒ

OUTPUT: Mono samples [Mâ‚, Mâ‚‚, Mâ‚ƒ]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[0.125, -0.19, 0.29]

WHY THIS MATTERS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âŒ If we sent stereo [L,R,L,R] to Whisper:
   Whisper thinks: [Tâ‚,Tâ‚‚,Tâ‚ƒ,Tâ‚„] (4 time samples)
   Result: 2Ã— speed playback â†’ Chipmunk voice â†’ Hallucinations!

âœ… If we send mono [Mâ‚,Mâ‚‚]:
   Whisper knows: [Tâ‚,Tâ‚‚] (2 time samples)
   Result: Correct speed â†’ Accurate transcription
```

---

## Resampling Pipeline (48kHz â†’ 16kHz)

### **Why Resampling is Necessary**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ğŸ¯ THE PROBLEM                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Microphone captures at:  48,000 samples/second                â”‚
â”‚  Whisper expects:         16,000 samples/second                â”‚
â”‚                                                                 â”‚
â”‚  Mismatch = 3Ã— too much data!                                  â”‚
â”‚                                                                 â”‚
â”‚  âŒ If we send 48kHz to Whisper:                               â”‚
â”‚     â€¢ Whisper thinks audio is 3Ã— slower (stretched)            â”‚
â”‚     â€¢ "Hello" sounds like "Heeeeellllllooooo" (slow motion)    â”‚
â”‚     â€¢ Model was trained on 16kHz, gets confused                â”‚
â”‚     â€¢ Transcription fails or hallucinates                      â”‚
â”‚                                                                 â”‚
â”‚  âœ… Solution: Resample 48kHz â†’ 16kHz                           â”‚
â”‚     â€¢ Keep every ~3rd sample (with smoothing)                  â”‚
â”‚     â€¢ Maintains audio content, changes sample rate             â”‚
â”‚     â€¢ Whisper receives expected format                         â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Resampling in Action**

```
LOCATION: Thread 2 (Whisper Processor) - transcribe_chunk()
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

INPUT:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
samples: &[f32]           // 6 seconds @ 48kHz = 288,000 samples
input_sample_rate: u32    // 48000

STEP 1: Check if resampling needed
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

if input_sample_rate != 16000 {
    // YES, need to resample
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚         RUBATO RESAMPLER                   â”‚
    â”‚  (High-quality Sinc interpolation)         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
}

STEP 2: Create Resampler (using rubato crate)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

use rubato::{Resampler, SincFixedIn, SincInterpolationParameters, ...};

let params = SincInterpolationParameters {
    sinc_len: 256,              // Window length (higher = better quality)
    f_cutoff: 0.95,             // Cutoff frequency (95% of Nyquist)
    interpolation: Linear,       // Interpolation method
    window: BlackmanHarris2,    // Windowing function (reduces artifacts)
    oversampling_factor: 128,   // Internal precision
};

let mut resampler = SincFixedIn::<f32>::new(
    16000.0 / 48000.0,  // Ratio: 0.333... (output/input)
    2.0,                // Max ratio change (not used in fixed mode)
    params,
    samples.len(),      // Input chunk size: 288,000
    1,                  // Channels: 1 (mono)
)?;

STEP 3: Resample the audio
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// Rubato expects Vec<Vec<f32>> for channels
let waves_in = vec![samples.to_vec()];

let waves_out = resampler.process(&waves_in, None)?;

// Extract resampled data
let audio_data = waves_out[0].clone();

OUTPUT:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
audio_data: Vec<f32>  // 6 seconds @ 16kHz = 96,000 samples

BEFORE RESAMPLING:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Time:  0ms    10ms   20ms   30ms   ...   6000ms
       â”‚      â”‚      â”‚      â”‚             â”‚
48kHz: â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—  288,000 points
       [Sample 1][Sample 2][Sample 3]...

AFTER RESAMPLING:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Time:  0ms    10ms   20ms   30ms   ...   6000ms
       â”‚      â”‚      â”‚      â”‚             â”‚
16kHz: â—  â—  â—  â—  â—  â—  â—  â—  â—  â—  â—  â—   96,000 points
       [Sample 1][Sample 2][Sample 3]...

Same audio content, 3Ã— fewer samples!
```

### **Visual Representation**

```
ORIGINAL: 48kHz (48,000 samples/second)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Time (ms):  0    1    2    3    4    5    6    7    8    ...
            â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
Samples:    â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—â—
            48   48   48   48   48   48   48   48   48

RESAMPLED: 16kHz (16,000 samples/second)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Time (ms):  0    1    2    3    4    5    6    7    8    ...
            â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚    â”‚
Samples:    â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€
            16   16   16   16   16   16   16   16   16

HOW SINC INTERPOLATION WORKS:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Instead of just "dropping" samples, we use a sinc function to
intelligently compute new samples that preserve audio quality.

48kHz samples:  [0.1, 0.2, 0.3, 0.25, 0.15, 0.1, 0.05, ...]
                  â”‚    â”‚    â”‚     â”‚     â”‚    â”‚    â”‚
                  â”‚    â”‚    â”‚     â”‚     â”‚    â”‚    â”‚
Sinc filter:     â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€
                  â”‚         â”‚              â”‚
16kHz samples:   [0.1,     0.27,         0.12, ...]

Each output sample is a weighted average of nearby input samples.
```

---

## Whisper Processing Pipeline

### **Complete Data Flow to Model**

```
THREAD 2: Whisper Processor Thread
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 1: Buffering                                             â”‚
â”‚                                                                 â”‚
â”‚  let mut buffer = Vec::new();                                  â”‚
â”‚  let chunk_size = (sample_rate * 6) as usize;  // 288,000      â”‚
â”‚                                                                 â”‚
â”‚  while let Ok(samples) = whisper_rx.recv() {                   â”‚
â”‚      buffer.extend(samples);  // Add incoming audio            â”‚
â”‚      â”‚                                                          â”‚
â”‚      â”‚ State of buffer over time:                              â”‚
â”‚      â”‚ 0.0s  â†’ [0 samples]                                     â”‚
â”‚      â”‚ 0.5s  â†’ [24,000 samples]                                â”‚
â”‚      â”‚ 1.0s  â†’ [48,000 samples]                                â”‚
â”‚      â”‚ 3.0s  â†’ [144,000 samples]                               â”‚
â”‚      â”‚ 6.0s  â†’ [288,000 samples] âœ“ Ready!                      â”‚
â”‚      â”‚                                                          â”‚
â”‚      â””â”€â–º if buffer.len() >= chunk_size { ... }                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Buffer has 6 seconds of audio
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 2: Extract Chunk                                         â”‚
â”‚                                                                 â”‚
â”‚  let chunk: Vec<f32> = buffer.drain(..chunk_size).collect();   â”‚
â”‚                                                                 â”‚
â”‚  Before drain:                                                  â”‚
â”‚  buffer = [sâ‚,sâ‚‚,sâ‚ƒ,...,sâ‚‚â‚ˆâ‚ˆâ‚€â‚€â‚€, sâ‚‚â‚ˆâ‚ˆâ‚€â‚€â‚, sâ‚‚â‚ˆâ‚ˆâ‚€â‚€â‚‚, ...]        â”‚
â”‚            â””â”€â”€ 6 seconds â”€â”€â”˜    â””â”€â”€ overflow â”€â”€â”˜              â”‚
â”‚                                                                 â”‚
â”‚  After drain:                                                   â”‚
â”‚  chunk  = [sâ‚,sâ‚‚,sâ‚ƒ,...,sâ‚‚â‚ˆâ‚ˆâ‚€â‚€â‚€]  // Moved out                 â”‚
â”‚  buffer = [sâ‚‚â‚ˆâ‚ˆâ‚€â‚€â‚, sâ‚‚â‚ˆâ‚ˆâ‚€â‚€â‚‚, ...]  // Remaining                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ chunk = 288,000 samples @ 48kHz
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 3: Resample to 16kHz                                     â”‚
â”‚                                                                 â”‚
â”‚  Input:  288,000 samples @ 48kHz                               â”‚
â”‚  Output:  96,000 samples @ 16kHz                               â”‚
â”‚                                                                 â”‚
â”‚  let audio_data = resample(chunk, 48000);                      â”‚
â”‚                                                                 â”‚
â”‚  [See resampling section above for details]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ audio_data = 96,000 samples @ 16kHz
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 4: Call Whisper Manager                                 â”‚
â”‚                                                                 â”‚
â”‚  match whisper                                                  â”‚
â”‚      .lock()      // Get exclusive access to WhisperManager    â”‚
â”‚      .unwrap()                                                  â”‚
â”‚      .transcribe_chunk(&audio_data, sample_rate)               â”‚
â”‚  {                                                              â”‚
â”‚      Ok(transcript) => println!("{}", transcript),             â”‚
â”‚      Err(e) => eprintln!("Error: {}", e),                      â”‚
â”‚  }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Inside WhisperManager
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 5: Whisper Context Processing                           â”‚
â”‚  (Inside whisper.rs - transcribe_chunk)                        â”‚
â”‚                                                                 â”‚
â”‚  [5.1] Create State                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚ let mut state = ctx.create_state() â”‚                        â”‚
â”‚  â”‚                                    â”‚                        â”‚
â”‚  â”‚ This allocates GPU/CPU memory for  â”‚                        â”‚
â”‚  â”‚ this specific transcription.       â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                 â”‚
â”‚  [5.2] Set Parameters                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ let mut params = FullParams::new(              â”‚            â”‚
â”‚  â”‚     SamplingStrategy::Greedy { best_of: 1 }   â”‚            â”‚
â”‚  â”‚ );                                             â”‚            â”‚
â”‚  â”‚                                                â”‚            â”‚
â”‚  â”‚ params.set_n_threads(4);         // Use 4 CPU cores        â”‚
â”‚  â”‚ params.set_language(Some("en")); // English                â”‚
â”‚  â”‚ params.set_translate(false);     // Don't translate        â”‚
â”‚  â”‚                                                â”‚            â”‚
â”‚  â”‚ // CONTEXT HISTORY (reduces hallucinations!)   â”‚            â”‚
â”‚  â”‚ if !self.last_transcript.is_empty() {          â”‚            â”‚
â”‚  â”‚     params.set_initial_prompt(&self.last_transcript);      â”‚
â”‚  â”‚ }                                              â”‚            â”‚
â”‚  â”‚                                                â”‚            â”‚
â”‚  â”‚ Example: If previous chunk was "Hello my",     â”‚            â”‚
â”‚  â”‚          this chunk will know to continue      â”‚            â”‚
â”‚  â”‚          that sentence instead of random words â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚  [5.3] Run Inference                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ state.full(params, &audio_data)?;              â”‚            â”‚
â”‚  â”‚                                                â”‚            â”‚
â”‚  â”‚ This is where the AI magic happens:            â”‚            â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚            â”‚
â”‚  â”‚ â”‚  1. Load audio into GPU memory   â”‚           â”‚            â”‚
â”‚  â”‚ â”‚  2. Run mel-spectrogram conversionâ”‚          â”‚            â”‚
â”‚  â”‚ â”‚  3. Encoder: Audio â†’ Features     â”‚           â”‚            â”‚
â”‚  â”‚ â”‚  4. Decoder: Features â†’ Text      â”‚           â”‚            â”‚
â”‚  â”‚ â”‚  5. Tokenize output              â”‚           â”‚            â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚            â”‚
â”‚  â”‚                                                â”‚            â”‚
â”‚  â”‚ GPU Memory Usage: ~2 GB for large-v3           â”‚            â”‚
â”‚  â”‚ Processing Time: ~2 seconds on RTX 4070        â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚  [5.4] Extract Segments                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ let num_segments = state.full_n_segments();    â”‚            â”‚
â”‚  â”‚                                                â”‚            â”‚
â”‚  â”‚ let mut transcript = String::new();            â”‚            â”‚
â”‚  â”‚ for i in 0..num_segments {                     â”‚            â”‚
â”‚  â”‚     let segment = state.get_segment(i);        â”‚            â”‚
â”‚  â”‚     transcript.push_str(&segment.to_string()); â”‚            â”‚
â”‚  â”‚ }                                              â”‚            â”‚
â”‚  â”‚                                                â”‚            â”‚
â”‚  â”‚ Example output:                                â”‚            â”‚
â”‚  â”‚ segment[0]: " Hello"                           â”‚            â”‚
â”‚  â”‚ segment[1]: " my"                              â”‚            â”‚
â”‚  â”‚ segment[2]: " name"                            â”‚            â”‚
â”‚  â”‚ segment[3]: " is"                              â”‚            â”‚
â”‚  â”‚ segment[4]: " John"                            â”‚            â”‚
â”‚  â”‚                                                â”‚            â”‚
â”‚  â”‚ Combined: "Hello my name is John"              â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                 â”‚
â”‚  [5.5] Save Context & Return                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚ self.last_transcript = transcript.clone();     â”‚            â”‚
â”‚  â”‚ Ok(transcript)                                 â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Return transcript string
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 6: Output                                                â”‚
â”‚                                                                 â”‚
â”‚  println!("[TRANSCRIPT] \"{}\"", transcript);                   â”‚
â”‚                                                                 â”‚
â”‚  Console Output:                                                â”‚
â”‚  [TRANSCRIPT] "Hello my name is John"                           â”‚
â”‚  [PERF] Processed 6.00s audio in 2100ms | Speed: 2.9x          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **Inside the Whisper Model (GPU)**

```
WHISPER MODEL ARCHITECTURE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Input: audio_data (96,000 samples @ 16kHz)
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. MEL SPECTROGRAM                     â”‚
â”‚                                         â”‚
â”‚  Convert time-domain audio to           â”‚
â”‚  frequency-domain representation        â”‚
â”‚                                         â”‚
â”‚  [0.1, 0.2, 0.15, ...]                 â”‚
â”‚         â†“                               â”‚
â”‚  [[fâ‚,tâ‚], [fâ‚‚,tâ‚], ...,               â”‚
â”‚   [fâ‚,tâ‚‚], [fâ‚‚,tâ‚‚], ...]              â”‚
â”‚                                         â”‚
â”‚  80 mel-frequency bands Ã— 3000 frames   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ENCODER (Transformer)               â”‚
â”‚                                         â”‚
â”‚  Extract audio features                 â”‚
â”‚  â€¢ 1550M parameters (large-v3)         â”‚
â”‚  â€¢ 32 attention layers                  â”‚
â”‚  â€¢ Runs on GPU (CUDA/Vulkan)           â”‚
â”‚                                         â”‚
â”‚  Output: Audio embeddings               â”‚
â”‚  [1280-dimensional vectors per frame]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. DECODER (Transformer)               â”‚
â”‚                                         â”‚
â”‚  Generate text tokens one at a time     â”‚
â”‚                                         â”‚
â”‚  Step 1: [<start>] â†’ "Hello"           â”‚
â”‚  Step 2: "Hello" â†’ "my"                 â”‚
â”‚  Step 3: "Hello my" â†’ "name"            â”‚
â”‚  Step 4: "Hello my name" â†’ "is"         â”‚
â”‚  Step 5: "Hello my name is" â†’ "John"    â”‚
â”‚  Step 6: "Hello my name is John" â†’ <end>â”‚
â”‚                                         â”‚
â”‚  Uses initial_prompt as context!        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. TOKENIZER                           â”‚
â”‚                                         â”‚
â”‚  Convert token IDs to text              â”‚
â”‚  [1234, 5678, 9012] â†’ "Hello my name"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â”‚
  â–¼
Output: "Hello my name is John"

PERFORMANCE:
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â€¢ GPU: NVIDIA RTX 4070
â€¢ Model: large-v3 (3.0 GB)
â€¢ Input: 6 seconds of audio (96,000 samples @ 16kHz)
â€¢ Time: ~2.1 seconds
â€¢ Realtime Factor: 2.9Ã— (faster than realtime!)
```

---

## Thread Lifecycle

### **From Start to Stop**

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    ğŸš€ START RECORDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  T = 0ms                                                        â”‚
â”‚  User clicks "Start Recording"                                 â”‚
â”‚                                                                 â”‚
â”‚  Main Thread:                                                   â”‚
â”‚  âœ“ Create channels (file_tx/rx, whisper_tx/rx)                â”‚
â”‚  âœ“ Spawn Thread 1 (File Writer)                               â”‚
â”‚  âœ“ Spawn Thread 2 (Whisper Processor)                         â”‚
â”‚  âœ“ Start audio stream                                          â”‚
â”‚                                                                 â”‚
â”‚  Active Threads: 4                                              â”‚
â”‚  â‘  Main (Tauri)                                                â”‚
â”‚  â‘¡ File Writer (waiting on file_rx)                            â”‚
â”‚  â‘¢ Whisper Processor (waiting on whisper_rx)                   â”‚
â”‚  â‘£ OS Audio (capturing from mic)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  T = 10ms, 20ms, 30ms, ...                                     â”‚
â”‚  Audio streaming                                                â”‚
â”‚                                                                 â”‚
â”‚  OS Audio Thread:                                               â”‚
â”‚  â€¢ Capture 10ms of audio (480 samples)                         â”‚
â”‚  â€¢ Send to file_tx                                             â”‚
â”‚  â€¢ Send to whisper_tx (mono)                                   â”‚
â”‚  â€¢ Repeat every 10ms                                           â”‚
â”‚                                                                 â”‚
â”‚  Thread 1 (File Writer):                                        â”‚
â”‚  â€¢ Receives audio from file_rx                                 â”‚
â”‚  â€¢ Writes to WAV file                                          â”‚
â”‚  â€¢ Loop continues...                                           â”‚
â”‚                                                                 â”‚
â”‚  Thread 2 (Whisper):                                            â”‚
â”‚  â€¢ Receives audio from whisper_rx                              â”‚
â”‚  â€¢ Accumulates in buffer                                       â”‚
â”‚  â€¢ Waiting for 6 seconds...                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  T = 6000ms (6 seconds)                                         â”‚
â”‚  First transcription                                            â”‚
â”‚                                                                 â”‚
â”‚  Thread 2 (Whisper):                                            â”‚
â”‚  â€¢ Buffer reaches 288,000 samples                              â”‚
â”‚  â€¢ Drain 6s chunk                                              â”‚
â”‚  â€¢ Resample to 16kHz                                           â”‚
â”‚  â€¢ Lock WhisperManager                                          â”‚
â”‚  â€¢ Run transcription (~2 seconds on GPU)                       â”‚
â”‚  â€¢ Print result                                                 â”‚
â”‚  â€¢ Release lock                                                 â”‚
â”‚  â€¢ Continue buffering...                                        â”‚
â”‚                                                                 â”‚
â”‚  Meanwhile:                                                     â”‚
â”‚  â€¢ Audio stream still capturing                                â”‚
â”‚  â€¢ File writer still writing                                   â”‚
â”‚  â€¢ Whisper buffer accumulating next chunk                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  T = 12000ms, 18000ms, ...                                      â”‚
â”‚  Continuous transcription                                       â”‚
â”‚                                                                 â”‚
â”‚  Every 6 seconds:                                               â”‚
â”‚  â€¢ Whisper processes another chunk                             â”‚
â”‚  â€¢ Uses previous transcript as context                         â”‚
â”‚  â€¢ Better accuracy than isolated chunks!                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                    ğŸ›‘ STOP RECORDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User clicks "Stop Recording"                                   â”‚
â”‚                                                                 â”‚
â”‚  Main Thread:                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ let mut handle = state.recording_handle          â”‚          â”‚
â”‚  â”‚     .lock().unwrap();                            â”‚          â”‚
â”‚  â”‚                                                  â”‚          â”‚
â”‚  â”‚ if let Some(recording) = handle.take() {        â”‚          â”‚
â”‚  â”‚     // [1] Stop microphone                      â”‚          â”‚
â”‚  â”‚     drop(recording.stream);                     â”‚          â”‚
â”‚  â”‚         â†“                                        â”‚          â”‚
â”‚  â”‚     OS Audio Thread terminates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚          â”‚
â”‚  â”‚                                          â”‚      â”‚          â”‚
â”‚  â”‚     // [2] Close file channel            â”‚      â”‚          â”‚
â”‚  â”‚     drop(recording.file_tx); â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”   â”‚          â”‚
â”‚  â”‚                                          â”‚  â”‚   â”‚          â”‚
â”‚  â”‚     // [3] Close whisper channel         â”‚  â”‚   â”‚          â”‚
â”‚  â”‚     drop(recording.whisper_tx); â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â” â”‚          â”‚
â”‚  â”‚ }                                        â”‚  â”‚ â”‚ â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”¼â”€â”¼â”€â”˜          â”‚
â”‚                                             â”‚  â”‚ â”‚            â”‚
â”‚                                             â–¼  â–¼ â–¼            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ OS Audio Thread â”‚  â”‚ Thread 1        â”‚  â”‚ Thread 2    â”‚   â”‚
â”‚  â”‚                 â”‚  â”‚ (File Writer)   â”‚  â”‚ (Whisper)   â”‚   â”‚
â”‚  â”‚ âœ“ Stopped       â”‚  â”‚                 â”‚  â”‚             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ file_rx sees    â”‚  â”‚ whisper_rx  â”‚   â”‚
â”‚                       â”‚ channel closed  â”‚  â”‚ sees closed â”‚   â”‚
â”‚                       â”‚                 â”‚  â”‚             â”‚   â”‚
â”‚                       â”‚ Exits recv loop â”‚  â”‚ Process     â”‚   â”‚
â”‚                       â”‚ Calls finalize()â”‚  â”‚ remaining   â”‚   â”‚
â”‚                       â”‚                 â”‚  â”‚ audio       â”‚   â”‚
â”‚                       â”‚ âœ“ WAV saved     â”‚  â”‚             â”‚   â”‚
â”‚                       â”‚ âœ“ Thread exits  â”‚  â”‚ âœ“ Done      â”‚   â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sleep 500ms                                                    â”‚
â”‚  (Ensure file write completes)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Final High-Quality Transcription                              â”‚
â”‚                                                                 â”‚
â”‚  Main Thread:                                                   â”‚
â”‚  let path = state.last_recording_path.lock().unwrap();         â”‚
â”‚  let transcript = state.whisper.lock().unwrap()                â”‚
â”‚      .transcribe_file(&path)?;                                 â”‚
â”‚                                                                 â”‚
â”‚  â€¢ Loads entire WAV file                                       â”‚
â”‚  â€¢ Processes all audio at once (not chunks)                    â”‚
â”‚  â€¢ No context needed (has full recording)                      â”‚
â”‚  â€¢ Returns complete transcript                                 â”‚
â”‚  â€¢ Frontend displays result                                    â”‚
â”‚                                                                 â”‚
â”‚  Active Threads: 1 (Main only)                                 â”‚
â”‚  âœ“ All worker threads cleaned up                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

### **Key Takeaways**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ğŸ¯ THREADING STRATEGY                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  âœ… Non-blocking UI (main thread never freezes)              â”‚
â”‚  âœ… Real-time transcription (6-second chunks)                â”‚
â”‚  âœ… High-quality final result (full file processing)         â”‚
â”‚  âœ… Thread-safe communication (channels)                     â”‚
â”‚  âœ… Clean shutdown (drop channels â†’ threads exit)            â”‚
â”‚                                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  ğŸµ AUDIO PIPELINE                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  1. Capture:    Mic â†’ 48kHz Stereo â†’ OS Thread               â”‚
â”‚  2. Split:      Stereo â†’ File, Mono â†’ Whisper                â”‚
â”‚  3. Channel:    Lock-free send/recv between threads          â”‚
â”‚  4. Resample:   48kHz â†’ 16kHz (rubato sinc interpolation)    â”‚
â”‚  5. Transcribe: 16kHz â†’ Whisper Model â†’ Text                 â”‚
â”‚                                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  ğŸ”’ MEMORY SAFETY                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â€¢ Channels: Transfer ownership (no shared memory)           â”‚
â”‚  â€¢ Arc<Mutex>: Shared state with exclusive access            â”‚
â”‚  â€¢ move: Thread takes ownership, prevents data races         â”‚
â”‚  â€¢ drop: Clean automatic resource cleanup                    â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Next Steps**: Try running the app and watch the console output to see this entire pipeline in action! Each `[TRANSCRIPT]` line you see is the result of this complex threading and audio processing system working in perfect harmony. ğŸµâ†’ğŸ“
