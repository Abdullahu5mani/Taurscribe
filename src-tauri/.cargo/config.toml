[target.x86_64-pc-windows-msvc]
rustflags = [
    # Force dynamic CRT (MD) cleanly.
    # This replaces all the /NODEFAULTLIB and /DEFAULTLIB hacks.
    "-C", "target-feature=-crt-static",
    # Add your library search path if strictly necessary (usually handled by PATH, but keeping it is fine)
    "-L", "C:/Users/abdul/OneDrive/Desktop/Taurscribe/taurscribe-runtime/bin",
    # ── Diamond dependency fix (whisper-rs ggml vs llama-cpp-2 ggml) ──
    # whisper-rs-sys statically links ggml into its .rlib.
    # llama-cpp-sys-2 (dynamic-link) provides ggml import-library thunks.
    # Both define the same ggml_* symbols → LNK2005.
    # /FORCE:MULTIPLE lets the linker accept both; the static whisper
    # definitions win in the host binary while llama.dll uses its own
    # ggml-base.dll via the DLL's private import table.
    # /ignore:4006 suppresses the per-symbol "already defined" warnings.
    "-C", "link-arg=/FORCE:MULTIPLE",
    "-C", "link-arg=/ignore:4006",
]

# ── macOS Intel ──
# Note: macOS ld64 naturally resolves the diamond dependency (whisper static ggml
# vs llama dynamic ggml) without special flags; the static symbols win in the
# binary and llama.dylib uses its own private copies at runtime.
[target.x86_64-apple-darwin]
rustflags = [
    "-C",
    "link-arg=-mmacosx-version-min=13.4",
    "-lc++",
    "-l",
    "framework=Accelerate",
]

# ── macOS Apple Silicon (ARM64) ──
[target.aarch64-apple-darwin]
rustflags = [
    "-C",
    "link-arg=-mmacosx-version-min=13.4",
    "-lc++",
    "-l",
    "framework=Accelerate",
]

# ── Windows ARM64: diamond dependency fix ──
[target.aarch64-pc-windows-msvc]
rustflags = [
    "-C", "link-arg=/FORCE:MULTIPLE",
    "-C", "link-arg=/ignore:4006",
]

[env]
MACOSX_DEPLOYMENT_TARGET = "13.4"
WHISPER_LIB_DIR = "C:/Users/abdul/OneDrive/Desktop/Taurscribe/taurscribe-runtime/bin"
GRAMMAR_LLM_DIR = "C:/Users/abdul/OneDrive/Desktop/Taurscribe/taurscribe-runtime/models/qwen_finetuned_gguf"
VULKAN_SDK = "C:/VulkanSDK/1.4.335.0"
LIBCLANG_PATH = "C:/Program Files/Microsoft Visual Studio/2022/Community/VC/Tools/Llvm/x64/bin"
CFLAGS = "/MD"
CXXFLAGS = "/MD"
# Force MSVC (and nvcc's host compiler) to use dynamic CRT (/MD) so
# llama-cpp-sys-2 CUDA kernels match whisper_rs. Without this, nvcc
# builds with /MT and link fails with LNK2038.
CL = "/MD"

# ── Linux x86_64: diamond dependency fix (same ggml conflict as Windows) ──
[target.x86_64-unknown-linux-gnu]
rustflags = [
    # whisper-rs-sys statically links ggml; llama-cpp-sys-2 (dynamic-link)
    # provides its own libggml.so with the same symbols → duplicate definition.
    # --allow-multiple-definition is the GNU ld equivalent of MSVC /FORCE:MULTIPLE.
    "-C", "link-arg=-Wl,--allow-multiple-definition",
]

# ── Linux ARM64: same diamond dependency fix ──
[target.aarch64-unknown-linux-gnu]
rustflags = [
    "-C", "link-arg=-Wl,--allow-multiple-definition",
]

[target.x86_64-pc-windows-gnu]
linker = "C:\\msys64\\ucrt64\\bin\\gcc.exe"
ar = "C:\\msys64\\ucrt64\\bin\\ar.exe"

[build]
target-dir = "C:/bld"
