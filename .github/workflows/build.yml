name: Build & Test

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

# Cancel in-progress runs when a new workflow is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # 1. macOS (Apple Silicon) - STABLE (DO NOT CHANGE LOGIC)
          - platform: 'macos-latest'
            name: 'macOS (Apple Silicon)'
            target: 'aarch64-apple-darwin'
            cuda: false
            os_name: 'macOS'
            arch: 'ARM64'
            acceleration: 'Metal'

          # 3. Windows (x86_64)
          - platform: 'windows-latest'
            name: 'Windows (x86_64)'
            target: 'x86_64-pc-windows-msvc'
            cuda: true
            os_name: 'Windows'
            arch: 'x86_64'
            acceleration: 'CUDA'

          # 4. Windows (ARM64)
          - platform: 'windows-latest'
            name: 'Windows (ARM64)'
            target: 'aarch64-pc-windows-msvc'
            cuda: false
            os_name: 'Windows'
            arch: 'ARM64'
            acceleration: 'CPU'

          # 5. Linux (x86_64)
          - platform: 'ubuntu-22.04'
            name: 'Linux (x86_64)'
            target: 'x86_64-unknown-linux-gnu'
            cuda: true
            os_name: 'Linux'
            arch: 'x86_64'
            acceleration: 'CUDA'
          
          # Note: Linux ARM builds are complex on GitHub Actions due to GTK linking.
          # This configuration attempts it but it may require a dedicated ARM runner or container.
          # We use standard runner but specify the target.
          # - platform: 'ubuntu-22.04' 
          #   name: 'Linux (ARM64)'
          #   target: 'aarch64-unknown-linux-gnu'
          #   cuda: false

    runs-on: ${{ matrix.platform }}
    name: Build - ${{ matrix.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- CUDA Setup (Windows/Linux x86 Only) ---
      - name: Install CUDA Toolkit
        if: matrix.cuda == true
        uses: Jimver/cuda-toolkit@v0.2.14
        id: cuda-toolkit
        with:
          cuda: '12.2.0'
          method: 'network'
          use-github-cache: false
          use-local-cache: false

      - name: Show CUDA Info
        if: matrix.cuda == true
        run: |
          nvcc --version
          echo "CUDA_PATH=${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
          
      # --- System Dependencies ---
      
      # Linux Dependencies
      - name: Install Linux SDK
        if: contains(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libasound2-dev build-essential curl wget file libssl-dev libgtk-3-dev libvulkan-dev
          # If Cross-compiling for ARM on x86 runner (if enabled later):
          # sudo apt-get install -y gcc-aarch64-linux-gnu

      # Windows Dependencies
      - name: Install Vulkan SDK (Windows)
        if: matrix.platform == 'windows-latest' && matrix.arch == 'x86_64'
        run: |
          choco install vulkan-sdk -y

      - name: Install LLVM (Windows)
        if: contains(matrix.platform, 'windows')
        run: |
          choco install llvm -y
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV

      # --- Rust Setup ---
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Remove Windows cargo config on Unix
        if: runner.os != 'Windows'
        run: rm -f src-tauri/.cargo/config.toml
 
      # macOS Dependencies
      - name: Install macOS Dependencies
        if: contains(matrix.platform, 'macos')
        run: |
          if [[ "${{ matrix.target }}" == *"aarch64"* ]]; then
            echo "ðŸ macOS ARM (Apple Silicon) - Using Homebrew"
            brew install onnxruntime
            echo "ORT_STRATEGY=system" >> $GITHUB_ENV
            echo "ORT_LIB_LOCATION=$(brew --prefix onnxruntime)/lib" >> $GITHUB_ENV
          else
            echo "ðŸ’» macOS Intel (x86_64) - Downloading manual binary"
            # Manually download ONNX Runtime 1.16.3 for Intel Mac
            wget https://github.com/microsoft/onnxruntime/releases/download/v1.16.3/onnxruntime-osx-x86_64-1.16.3.tgz
            tar -xzf onnxruntime-osx-x86_64-1.16.3.tgz
            
            EXTRACT_PATH="$(pwd)/onnxruntime-osx-x86_64-1.16.3"
            echo "ORT_STRATEGY=system" >> $GITHUB_ENV
            echo "ORT_LIB_LOCATION=$EXTRACT_PATH/lib" >> $GITHUB_ENV
            echo "ORT_INCLUDE_LOCATION=$EXTRACT_PATH/include" >> $GITHUB_ENV
          fi
        shell: bash

      # --- JS/Frontend Setup ---
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install frontend dependencies
        run: bun install

      # --- Build ---
      - name: Build Tauri application
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Fix for whisper.cpp on older macOS targets
          MACOSX_DEPLOYMENT_TARGET: ${{ contains(matrix.platform, 'macos') && '10.15' || '' }}
          CMAKE_OS_CONTEXT_TARGET: ${{ contains(matrix.platform, 'macos') && '10.15' || '' }}
          # CUDA env vars
          CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
        with:
          args: --target ${{ matrix.target }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*
            src-tauri/target/release/bundle/**/*
          if-no-files-found: warn
          retention-days: 7
