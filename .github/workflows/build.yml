name: Build & Test

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

# Cancel in-progress runs when a new workflow is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          # 1. macOS (Apple Silicon) - STABLE (DO NOT CHANGE LOGIC)
          - platform: 'macos-latest'
            name: 'macOS (Apple Silicon)'
            target: 'aarch64-apple-darwin'
            cuda: false
            os_name: 'macOS'
            arch: 'ARM64'
            acceleration: 'Metal'

          # 3. Windows (x86_64)
          - platform: 'windows-latest'
            name: 'Windows (x86_64)'
            target: 'x86_64-pc-windows-msvc'
            cuda: true
            os_name: 'Windows'
            arch: 'x86_64'
            acceleration: 'CUDA'

          # 4. Windows (ARM64)
          - platform: 'windows-latest'
            name: 'Windows (ARM64)'
            target: 'aarch64-pc-windows-msvc'
            cuda: false
            os_name: 'Windows'
            arch: 'ARM64'
            acceleration: 'CPU'

          # 5. Linux (x86_64)
          - platform: 'ubuntu-24.04'
            name: 'Linux (x86_64)'
            target: 'x86_64-unknown-linux-gnu'
            cuda: true
            os_name: 'Linux'
            arch: 'x86_64'
            acceleration: 'CUDA'
          
          # Note: Linux ARM builds are complex on GitHub Actions due to GTK linking.
          # This configuration attempts it but it may require a dedicated ARM runner or container.
          # We use standard runner but specify the target.
          # - platform: 'ubuntu-22.04' 
          #   name: 'Linux (ARM64)'
          #   target: 'aarch64-unknown-linux-gnu'
          #   cuda: false

    runs-on: ${{ matrix.platform == 'windows-latest' && 'windows-2019' || matrix.platform }}
    name: Build - ${{ matrix.name }}

    steps:
      - name: Enable long paths for Git
        run: git config --global core.longpaths true

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable Long File Paths (Windows)
        if: contains(matrix.platform, 'windows')
        run: |
          New-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\FileSystem" -Name "LongPathsEnabled" -Value 1 -PropertyType DWord -Force

      # --- CUDA Setup (Windows/Linux x86 Only) ---
      - name: Install CUDA Toolkit (Linux)
        if: contains(matrix.platform, 'ubuntu') && matrix.cuda == true
        run: |
          wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
          sudo dpkg -i cuda-keyring_1.1-1_all.deb
          sudo apt-get update
          sudo apt-get -y install cuda-toolkit-12-6
          echo "CUDA_PATH=/usr/local/cuda-12.6" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=/usr/local/cuda-12.6/lib64:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "PATH=/usr/local/cuda-12.6/bin:$PATH" >> $GITHUB_ENV
          
      - name: Install CUDA Toolkit (Windows)
        if: contains(matrix.platform, 'windows') && matrix.cuda == true
        uses: Jimver/cuda-toolkit@v0.2.21
        id: cuda-toolkit
        with:
          cuda: '12.5.1'
          method: 'network'
          use-github-cache: false
          use-local-cache: false

      - name: Show CUDA Info
        if: matrix.cuda == true
        run: |
          nvcc --version
          echo "CUDA_PATH=${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
          
      # --- System Dependencies ---
      
      # macOS Dependencies
      - name: Verify macOS Build Tools
        if: contains(matrix.platform, 'macos')
        run: |
          echo "=== macOS Build Environment ==="
          echo "macOS Version:"
          sw_vers
          echo ""
          echo "Xcode Version:"
          xcodebuild -version || echo "Xcode command line tools not found"
          echo ""
          echo "CMake Version:"
          cmake --version || { echo "ERROR: CMake not found!"; brew install cmake; }
          echo ""
          echo "Checking deployment target:"
          echo "MACOSX_DEPLOYMENT_TARGET will be set to: 13.4"
          echo ""
          echo "=== Verification complete ==="
      
      # Linux Dependencies
      - name: Install Linux System Dependencies
        if: contains(matrix.platform, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            libasound2-dev \
            build-essential \
            curl wget file \
            libssl-dev \
            libgtk-3-dev \
            cmake

      - name: Install Vulkan SDK (Linux)
        if: contains(matrix.platform, 'ubuntu')
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          version: 1.4.309.0
          cache: true
          
      - name: Verify Vulkan Installation (Linux)
        if: contains(matrix.platform, 'ubuntu')
        run: |
          echo "=== Vulkan SDK Verification ==="
          echo "VULKAN_SDK: $VULKAN_SDK"
          echo "VK_ICD_FILENAMES: $VK_ICD_FILENAMES"
          echo "VK_LAYER_PATH: $VK_LAYER_PATH"
          echo ""
          echo "Checking glslc (REQUIRED)..."
          which glslc && glslc --version || { echo "ERROR: glslc not found!"; exit 1; }
          echo ""
          echo "Checking SPIR-V tools..."
          which spirv-as && spirv-as --version || echo "INFO: spirv-as not found (optional)"
          which spirv-opt && spirv-opt --version || echo "INFO: spirv-opt not found (optional)"
          echo ""
          echo "Checking Vulkan runtime..."
          which vulkaninfo && vulkaninfo --summary || echo "INFO: vulkaninfo failed (no GPU in CI, expected)"
          echo ""
          echo "=== Verification complete - glslc is available ==="

      # Windows Dependencies
      - name: Install Vulkan SDK (Windows)
        if: matrix.platform == 'windows-latest' && matrix.arch == 'x86_64'
        uses: humbletim/install-vulkan-sdk@v1.2
        with:
          version: 1.4.309.0
          cache: true

      - name: Install LLVM (Windows)
        if: contains(matrix.platform, 'windows')
        run: |
          choco install llvm -y
          echo "LIBCLANG_PATH=C:\Program Files\LLVM\bin" >> $env:GITHUB_ENV

          
      - name: Configure Clang for ARM64 (Windows)
        if: matrix.target == 'aarch64-pc-windows-msvc'
        run: |
           echo "CC=clang-cl" >> $env:GITHUB_ENV
           echo "CXX=clang-cl" >> $env:GITHUB_ENV
           echo "CMAKE_GENERATOR_TOOLSET=ClangCL" >> $env:GITHUB_ENV
      # --- Rust Setup ---
      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      - name: Clean Windows-specific paths from cargo config on Unix
        if: runner.os != 'Windows'
        run: |
          # Remove Windows-specific sections but keep macOS and Linux configs
          sed -i.bak '/\[target\.x86_64-pc-windows-msvc\]/,/^$/d' src-tauri/.cargo/config.toml || true
          sed -i.bak '/\[target\.x86_64-pc-windows-gnu\]/,/^$/d' src-tauri/.cargo/config.toml || true
          sed -i.bak '/WHISPER_LIB_DIR/d' src-tauri/.cargo/config.toml || true
          sed -i.bak '/VULKAN_SDK.*VulkanSDK/d' src-tauri/.cargo/config.toml || true
          sed -i.bak '/LIBCLANG_PATH.*Microsoft/d' src-tauri/.cargo/config.toml || true
          sed -i.bak '/target-dir.*C:\/bld/d' src-tauri/.cargo/config.toml || true
          echo "=== Cleaned cargo config for Unix ==="
          cat src-tauri/.cargo/config.toml
 


      # --- JS/Frontend Setup ---
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install frontend dependencies
        run: bun install

      - name: Clean CMake Cache
        if: matrix.target == 'aarch64-pc-windows-msvc'
        run: |
          Get-ChildItem -Path C:\bld -Recurse -Filter CMakeCache.txt -ErrorAction SilentlyContinue | Remove-Item -Force
          Get-ChildItem -Path C:\bld -Recurse -Filter CMakeFiles -Directory -ErrorAction SilentlyContinue | Remove-Item -Recurse -Force

      # --- Build ---
      - name: Build Tauri application
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MSBUILDDISABLENODEREUSE: 1
          # macOS: ONNX Runtime deployment target (both env vars for Rust and CMake)
          MACOSX_DEPLOYMENT_TARGET: ${{ contains(matrix.platform, 'macos') && '13.4' || '' }}
          CMAKE_OSX_DEPLOYMENT_TARGET: ${{ contains(matrix.platform, 'macos') && '13.4' || '' }}
          # CUDA: NVIDIA GPU toolkit
          CUDA_PATH: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}
          # Vulkan: Linux SDK paths (set by previous step on Linux)
          VULKAN_SDK: ${{ env.VULKAN_SDK }}
          VK_ICD_FILENAMES: ${{ env.VK_ICD_FILENAMES }}
          VK_LAYER_PATH: ${{ env.VK_LAYER_PATH }}
        with:
          args: --target ${{ matrix.target }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/**/*
            src-tauri/target/release/bundle/**/*
          if-no-files-found: warn
          retention-days: 7
