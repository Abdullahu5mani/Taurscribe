name: Build & Test

on:
  push:
    branches: ['*']
  pull_request:
    branches: ['*']

# Cancel in-progress runs when a new workflow is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest'
            args: '--target aarch64-apple-darwin'
            name: 'macOS (Apple Silicon)'
          - platform: 'macos-latest'
            args: '--target x86_64-apple-darwin'
            name: 'macOS (Intel)'
          - platform: 'ubuntu-22.04'
            args: ''
            name: 'Linux'
          - platform: 'windows-latest'
            args: ''
            name: 'Windows'

    runs-on: ${{ matrix.platform }}
    name: Build - ${{ matrix.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: './src-tauri -> target'

      # Remove the Windows-specific .cargo/config.toml on non-Windows platforms
      # to prevent path conflicts (C:/bld breaking Unix builds)
      - name: Remove Windows cargo config on Unix
        if: matrix.platform != 'windows-latest'
        run: rm -f src-tauri/.cargo/config.toml

      - name: Install Linux dependencies
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install frontend dependencies
        run: bun install

      # Platform-specific whisper-rs features for CI builds
      - name: Patch Cargo.toml for platform-specific builds
        run: |
          if [[ "${{ matrix.platform }}" == "macos-latest" ]]; then
            # macOS: Use CoreML for Metal acceleration
            sed -i.bak 's/features = \["cuda", "vulkan"\]/features = ["coreml"]/g' src-tauri/Cargo.toml
            echo "✅ macOS: Enabled CoreML (Metal) acceleration"
          elif [[ "${{ matrix.platform }}" == "ubuntu-22.04" ]]; then
            # Linux: CPU-only build
            sed -i.bak 's/features = \["cuda", "vulkan"\]/features = []/g' src-tauri/Cargo.toml
            echo "✅ Linux: CPU-only build"
          fi
        shell: bash

      - name: Patch Cargo.toml for Windows
        if: matrix.platform == 'windows-latest'
        run: |
          # Windows: CPU-only build (CUDA/Vulkan not available in GitHub Actions)
          (Get-Content src-tauri/Cargo.toml) -replace 'features = \["cuda", "vulkan"\]', 'features = []' | Set-Content src-tauri/Cargo.toml
          Write-Host "✅ Windows: CPU-only build"
        shell: pwsh

      - name: Build Tauri application
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: ${{ matrix.args }}

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.platform }}${{ matrix.args && '-' }}${{ matrix.args && matrix.args }}
          path: |
            src-tauri/target/**/release/bundle/**/*
          if-no-files-found: warn
          retention-days: 7
